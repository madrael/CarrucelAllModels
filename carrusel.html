<!DOCTYPE html>
<!-- 18-09-2025 V1.0002 -->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title id="pageTitle">Galería – Modelos</title>
  <style>
    :root{
      --radius:14px; --shadow:0 8px 24px rgba(0,0,0,.08);
      --ink:#111; --muted:#4b5563; --line:#1f2937; --card:#fff;
      --padX:20px; --padY:28px;
      --wrapMax:1400px;                 /* ancho máximo fluido */
      --gap:22px;
    }
    *{box-sizing:border-box}
    html, body{height:100%}
    body{
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0; padding:var(--padY) var(--padX) 48px;
      color:var(--ink); background:#fff; overflow:hidden;
    }
    body.embed{ --padX:10px; --padY:10px; }

    h1{font-size:clamp(22px,3vw,44px);margin:0 0 6px;font-weight:650}
    .subheading{margin:0 0 14px;color:var(--muted);font-size:clamp(12px,1.8vw,16px)}

    /* ===== Contenedor FLUIDO (sin autoscale) ===== */
    .wrap{
      width:min(var(--wrapMax), 96vw);   /* ocupa el ancho disponible sin exceder wrapMax */
      margin:0 auto;
    }

    /* ===== Grid 2 columnas que se adapta ===== */
    .grid{
      display:grid; gap:var(--gap); align-items:stretch;
      grid-template-columns: minmax(420px, 1.25fr) minmax(320px, 1fr);
    }
    @media (max-width: 820px){
      .grid{ grid-template-columns: 1fr; }
    }

    /* ===== Figura responsive =====
       altura ligada al viewport para que “llene” pero sin desbordar */
    .figure{
      background:#f5f5f7;border-radius:var(--radius);overflow:hidden;
      box-shadow:var(--shadow);display:flex;align-items:center;justify-content:center;
      aspect-ratio: 16 / 9;                                /* relación estable */
      min-height: clamp(260px, 36vh, 520px);               /* se adapta al alto de ventana */
    }
    .figure img{
      width:100%; height:100%; object-fit:contain; display:block; background:#fff;
    }
    .fade{animation:fade .35s ease-out}
    @keyframes fade{from{opacity:.2} to{opacity:1}}

    /* ===== Columna de texto ===== */
    .textCol{border-radius:12px}
    .features{
      display:flex; flex-direction:column; gap:12px;
      max-height: 100%; overflow:auto;             /* se acota por JS para igualar figura */
    }
    .feat{
      background:var(--card);border:1px solid #e5e7eb;border-radius:12px;
      padding:12px 14px;box-shadow:0 1px 2px rgba(0,0,0,.03);
      position:relative;cursor:pointer
    }
    .feat-title{margin:0;font-size:clamp(14px,2.2vw,18px);font-weight:650;line-height:1.35}
    .feat-desc{margin:8px 2px 2px;color:var(--muted);line-height:1.55;font-size:clamp(12px,2vw,15px);display:none}
    .feat.active{border-color:#d1d5db}
    .feat.active::before{content:"";position:absolute;left:-1px;top:-1px;bottom:-1px;width:4px;border-radius:12px 0 0 12px;background:var(--line)}
    .feat.active .feat-desc{display:block}

    /* ===== Controles ===== */
    .controls-global{display:flex;justify-content:center;align-items:center;gap:14px;margin-top:14px}
    .btn{width:38px;height:38px;border-radius:50%;border:1px solid #d1d5db;background:#fff;display:grid;place-items:center;cursor:pointer;box-shadow:var(--shadow);transition:transform .08s}
    .btn:active{transform:scale(.96)}
    .btn svg{width:18px;height:18px}

    .notice{padding:12px 14px;border:1px solid #e5e7eb;border-radius:12px;background:#fff7ed;margin-top:12px;display:none}

    /* ===== Autoscale opcional SOLO si se pasa &fit=auto ===== */
    #autoscaleWrap{ transform-origin: top left; width:1180px; } /* usado cuando fit=auto */
  </style>
</head>
<body>
  <!-- Si usas &fit=auto el script moverá .wrap dentro de este contenedor para escalar -->
  <div id="autoscaleWrap" style="display:none"></div>

  <div class="wrap" id="wrap">
    <h1 id="modelTitle"></h1>
    <p id="sectionTitle" class="subheading">&nbsp;</p>

    <div class="grid">
      <figure class="figure" id="fig">
        <img id="hero" src="" alt="" />
      </figure>
      <section class="textCol">
        <div id="featureList" class="features" aria-label="Características"></div>
      </section>
    </div>

    <div class="controls-global">
      <button class="btn" id="prev" aria-label="Anterior">
        <svg viewBox="0 0 24 24" fill="none"><path d="M15 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="btn" id="next" aria-label="Siguiente">
        <svg viewBox="0 0 24 24" fill="none"><path d="M9 5l7 7-7 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
    </div>

    <div id="msg" class="notice"></div>
  </div>

  <script>
  (function(){
    const qs = new URLSearchParams(location.search);
    const modelKey = qs.get('model');
    const isInterior = (qs.get('Interior') || 'NO').toUpperCase() === 'SI';
    const sectionKey = isInterior ? 'interior' : 'exterior';
    const fit = (qs.get('fit') || '').toLowerCase();  // 'auto' => escalar para iframe
    const embed = qs.get('embed') === '1';
    if(embed) document.body.classList.add('embed');

    const wrap = document.getElementById('wrap');
    const autoscaleWrap = document.getElementById('autoscaleWrap');
    const hero = document.getElementById('hero');
    const figure = document.getElementById('fig');
    const list = document.getElementById('featureList');
    const modelTitle = document.getElementById('modelTitle');
    const sectionTitle = document.getElementById('sectionTitle');
    const pageTitle = document.getElementById('pageTitle');
    const msg = document.getElementById('msg');

    let slides = [], idx=0, imageBase='';

    function showMessage(t){ msg.textContent=t; msg.style.display='block'; }
    function clearMessage(){ msg.textContent=''; msg.style.display='none'; }

    // GH Pages: raíz o subcarpeta
    function jsonURL(){
      const segs = location.pathname.split('/').filter(Boolean);
      const repo = segs.length ? segs[0] : '';
      if (location.host.endsWith('github.io') && repo) return `/${repo}/AllModels.json`;
      return '/AllModels.json';
    }

    function renderSlides(slidesData){
      slides = slidesData;
      list.innerHTML = slides.map((s, i) => `
        <article class="feat" data-idx="${i}">
          <h3 class="feat-title">${s.title || ''}</h3>
          <p class="feat-desc">${s.desc || ''}</p>
        </article>
      `).join('');
      [...document.querySelectorAll('.feat')].forEach(el => {
        el.addEventListener('click', () => setActive(+el.dataset.idx));
      });
    }

    function setActive(newIdx){
      if(!slides.length) return;
      idx = (newIdx + slides.length) % slides.length;
      const s = slides[idx];
      const src = (s.img || s.image || s.src || '');
      hero.onerror = () => { showMessage('No se pudo cargar: ' + imageBase + src); };
      hero.onload  = () => { clearMessage(); syncHeights(); };
      hero.src = imageBase + src;
      hero.alt = s.title || '';
      hero.classList.remove('fade'); void hero.offsetWidth; hero.classList.add('fade');
      [...document.querySelectorAll('.feat')].forEach((el, k) => el.classList.toggle('active', k === idx));
      const activeItem = document.querySelector(`.feat[data-idx="${idx}"]`);
      if(activeItem) activeItem.scrollIntoView({block:'nearest', behavior:'smooth'});
    }

    document.getElementById('next').addEventListener('click', () => setActive(idx+1));
    document.getElementById('prev').addEventListener('click', () => setActive(idx-1));
    window.addEventListener('keydown', e => {
      if(e.key === 'ArrowRight') setActive(idx+1);
      if(e.key === 'ArrowLeft')  setActive(idx-1);
    });

    /* ==== Mantener la columna de texto “a la par” de la imagen ==== */
    function syncHeights(){
      // Ajusta la altura máxima de la lista para que no exceda la figura
      const h = figure.getBoundingClientRect().height;
      list.style.maxHeight = Math.max(220, Math.floor(h)) + 'px';
    }
    window.addEventListener('resize', syncHeights);

    /* ==== Autoscale SOLO si se pasa &fit=auto (para SeekOp) ==== */
    function ensureAutoscaleContainer(){
      if(fit !== 'auto') return;
      // mover el wrap dentro de autoscaleWrap y mostrarlo
      autoscaleWrap.style.display = 'block';
      if(wrap.parentElement !== autoscaleWrap){
        autoscaleWrap.appendChild(wrap);
      }
    }
    function autoScale(){
      if(fit !== 'auto') return;
      const baseW = 1180;
      const baseH = autoscaleWrap.scrollHeight;
      const padX = parseInt(getComputedStyle(document.body).getPropertyValue('--padX')) || 0;
      const padY = parseInt(getComputedStyle(document.body).getPropertyValue('--padY')) || 0;
      const vw = Math.max(0, window.innerWidth  - padX*2);
      const vh = Math.max(0, window.innerHeight - padY*2);
      const s = Math.max(0.5, Math.min(vw / baseW, vh / baseH));
      autoscaleWrap.style.transform = `scale(${s})`;
      autoscaleWrap.style.height = `${baseH}px`;
      document.body.style.overflow = 'hidden';
    }
    window.addEventListener('resize', autoScale);

    if(!modelKey){ showMessage('No se especificó ningún modelo en la URL.'); autoScale(); return; }

    fetch(jsonURL(), { cache: 'no-cache' })
      .then(r => { if(!r.ok) throw new Error('No se pudo cargar AllModels.json'); return r.json(); })
      .then(data => {
        const model = data && data.models && data.models[modelKey];
        if(!model){ showMessage(`No se encontró el modelo "${modelKey}" en AllModels.json.`); autoScale(); return; }
        clearMessage();

        imageBase = model.imageBase || '';
        const section = model.sections && (model.sections[sectionKey] || model.sections[sectionKey.charAt(0).toUpperCase()+sectionKey.slice(1)]);
        const slidesArr = (section && (section.slides || section.items)) || [];
        if(!Array.isArray(slidesArr) || !slidesArr.length){
          showMessage(`El modelo "${modelKey}" no tiene una sección "${sectionKey}" con slides/items.`);
          autoScale(); return;
        }

        pageTitle.textContent = `${model.displayName || modelKey} – Galería`;
        modelTitle.textContent = model.displayName || modelKey;
        sectionTitle.textContent = section.title || (isInterior ? 'Diseño interior' : 'Diseño exterior');

        const norm = slidesArr.map(x=>({
          img: x.img || x.image || x.src || '',
          title: x.title || x.titulo || '',
          desc: x.desc || x.caption || x.text || ''
        }));

        renderSlides(norm);
        setActive(0);

        ensureAutoscaleContainer();
        syncHeights();
        requestAnimationFrame(()=>{ autoScale(); syncHeights(); });
      })
      .catch(err => { console.error(err); showMessage('Error al cargar la configuración de modelos. Asegúrate de que AllModels.json esté en la raíz del repositorio.'); autoScale(); });
  })();
  </script>
</body>
</html>
